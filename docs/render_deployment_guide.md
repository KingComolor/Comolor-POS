# Render Deployment Guide for Comolor POS

## Overview

This guide covers deploying the Comolor POS system to Render.com, a modern cloud platform that provides managed PostgreSQL, automatic deployments, and SSL certificates.

## Prerequisites

1. **Render Account**: Sign up at [render.com](https://render.com)
2. **GitHub Repository**: Your code must be in a GitHub repository
3. **Domain (Optional)**: For custom domain setup

## Deployment Steps

### 1. Prepare Your Repository

1. **Create requirements.txt**
```txt
email-validator==2.1.1
flask==3.1.1
flask-login==0.6.3
flask-sqlalchemy==3.1.1
gunicorn==23.0.0
psycopg2-binary==2.9.9
reportlab==4.2.2
requests==2.31.0
sqlalchemy==2.0.36
werkzeug==3.1.1
```

2. **Create render.yaml** (Infrastructure as Code)
```yaml
databases:
  - name: comolor-pos-db
    databaseName: comolor_pos
    user: comolor_admin
    region: oregon

services:
  - type: web
    name: comolor-pos
    runtime: python3
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn --bind 0.0.0.0:$PORT main:app
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: comolor-pos-db
          property: connectionString
      - key: SESSION_SECRET
        generateValue: true
      - key: SECRET_KEY
        generateValue: true
      - key: PYTHON_VERSION
        value: 3.11.9
    healthCheckPath: /
    disk:
      name: comolor-pos-disk
      mountPath: /opt/render/project/uploads
      sizeGB: 1
```

3. **Update Production Configuration**

Create or update `production_config.py`:
```python
import os

class ProductionConfig:
    # Database
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')
    if SQLALCHEMY_DATABASE_URI and SQLALCHEMY_DATABASE_URI.startswith("postgres://"):
        SQLALCHEMY_DATABASE_URI = SQLALCHEMY_DATABASE_URI.replace("postgres://", "postgresql://", 1)
    
    SQLALCHEMY_ENGINE_OPTIONS = {
        'pool_size': 10,
        'pool_recycle': 3600,
        'pool_pre_ping': True,
        'max_overflow': 20,
        'pool_timeout': 30
    }
    
    # Security
    SECRET_KEY = os.environ.get('SECRET_KEY')
    SESSION_SECRET = os.environ.get('SESSION_SECRET')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # Session Security
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    PERMANENT_SESSION_LIFETIME = 86400  # 24 hours
    
    # MPesa Configuration
    MPESA_ENVIRONMENT = os.environ.get('MPESA_ENVIRONMENT', 'production')
    MPESA_CONSUMER_KEY = os.environ.get('MPESA_CONSUMER_KEY')
    MPESA_CONSUMER_SECRET = os.environ.get('MPESA_CONSUMER_SECRET')
    MPESA_PASSKEY = os.environ.get('MPESA_PASSKEY')
    MPESA_SHORTCODE = os.environ.get('MPESA_SHORTCODE')
    
    # File Uploads
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB
    UPLOAD_FOLDER = '/opt/render/project/uploads'
```

4. **Update main.py for Production**
```python
import os
from app import app

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))
    debug = os.environ.get('FLASK_ENV') == 'development'
    app.run(host='0.0.0.0', port=port, debug=debug)
```

### 2. Deploy to Render

#### Option A: Using Render Dashboard

1. **Connect GitHub Repository**
   - Go to Render Dashboard
   - Click "New +" → "Web Service"
   - Connect your GitHub repository
   - Select the repository

2. **Configure Web Service**
   - **Name**: `comolor-pos`
   - **Runtime**: `Python 3`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `gunicorn --bind 0.0.0.0:$PORT main:app`
   - **Instance Type**: `Starter` (free) or `Standard`

3. **Create PostgreSQL Database**
   - Go to Render Dashboard
   - Click "New +" → "PostgreSQL"
   - **Name**: `comolor-pos-db`
   - **Database Name**: `comolor_pos`
   - **User**: `comolor_admin`
   - **Region**: Same as web service

#### Option B: Using render.yaml (Recommended)

1. **Push render.yaml to Repository**
```bash
git add render.yaml
git commit -m "Add Render deployment configuration"
git push origin main
```

2. **Deploy from Dashboard**
   - Go to Render Dashboard
   - Click "New +" → "Blueprint"
   - Connect repository with render.yaml
   - Review and deploy

### 3. Environment Variables

Set these in Render Dashboard under "Environment":

**Required Variables:**
```
DATABASE_URL=<automatically set by Render>
SESSION_SECRET=<auto-generated or custom>
SECRET_KEY=<auto-generated or custom>
```

**MPesa Configuration:**
```
MPESA_ENVIRONMENT=production
MPESA_CONSUMER_KEY=your_consumer_key
MPESA_CONSUMER_SECRET=your_consumer_secret
MPESA_PASSKEY=your_passkey
MPESA_SHORTCODE=your_shortcode
```

**Optional Variables:**
```
FLASK_ENV=production
PYTHON_VERSION=3.11.9
```

### 4. Custom Domain Setup

1. **Add Custom Domain**
   - Go to Settings → Custom Domains
   - Add your domain (e.g., `pos.yourcompany.com`)

2. **Configure DNS**
   - Add CNAME record: `pos.yourcompany.com` → `your-app.onrender.com`
   - Or A record: `pos.yourcompany.com` → Render IP

3. **SSL Certificate**
   - Render automatically provides SSL certificates
   - Verify HTTPS is working

### 5. Post-Deployment Setup

1. **Create Super Admin User**
Access your deployed app and register the first super admin user, or run:
```bash
# Connect to your Render PostgreSQL database
psql $DATABASE_URL

# Insert super admin user (hash password beforehand)
INSERT INTO users (username, email, password_hash, role, user_active) 
VALUES ('admin', 'admin@yourcompany.com', 'hashed_password', 'super_admin', true);
```

2. **Configure MPesa Callbacks**
Update your MPesa callback URLs to point to your Render domain:
- Confirmation URL: `https://your-app.onrender.com/mpesa/c2b/confirmation`
- Validation URL: `https://your-app.onrender.com/mpesa/c2b/validation`

3. **Test All Functionality**
- [ ] User authentication
- [ ] POS operations
- [ ] MPesa payments
- [ ] Receipt generation
- [ ] Shop management
- [ ] Admin functions

## Render-Specific Considerations

### Database Management

1. **Backups**
   - Render provides automatic daily backups
   - Download manual backups from dashboard
   - Keep local backups for critical data

2. **Connection Limits**
   - Free tier: 97 connections
   - Paid plans: More connections available
   - Monitor connection usage

3. **Performance**
   - Use connection pooling (already configured)
   - Monitor query performance
   - Consider upgrading instance for high traffic

### File Storage

1. **Persistent Storage**
   - Use Render Disks for file uploads
   - Configure in render.yaml or dashboard
   - Files persist across deployments

2. **Static Files**
   - Render serves static files automatically
   - No additional configuration needed
   - Consider CDN for heavy static content

### Environment Management

1. **Environment Variables**
   - Set in Render Dashboard
   - Use Render's secret management
   - Group related variables

2. **Staging Environment**
   - Create separate service for staging
   - Use different database
   - Test before production deployment

## Monitoring and Maintenance

### Built-in Monitoring

1. **Render Dashboard**
   - View deployment logs
   - Monitor resource usage
   - Check service health

2. **Database Metrics**
   - Connection count
   - Query performance
   - Storage usage

### Custom Monitoring

1. **Application Logs**
```python
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s %(levelname)s %(message)s'
)
```

2. **Health Checks**
```python
@app.route('/health')
def health_check():
    try:
        # Test database connection
        db.session.execute('SELECT 1')
        return {'status': 'healthy', 'timestamp': datetime.utcnow().isoformat()}
    except Exception as e:
        return {'status': 'unhealthy', 'error': str(e)}, 500
```

## Scaling Considerations

### Vertical Scaling
- Upgrade instance type in Render Dashboard
- Monitor CPU and memory usage
- Scale based on user load

### Horizontal Scaling
- Render supports horizontal scaling
- Configure in service settings
- Consider session management with Redis

### Database Scaling
- Monitor database performance
- Upgrade PostgreSQL plan as needed
- Consider read replicas for heavy workloads

## Security Best Practices

1. **Environment Variables**
   - Never commit secrets to Git
   - Use Render's environment management
   - Rotate secrets regularly

2. **Database Security**
   - Use strong passwords
   - Enable SSL (default on Render)
   - Limit database access

3. **Application Security**
   - Keep dependencies updated
   - Monitor security advisories
   - Regular security audits

## Troubleshooting

### Common Issues

1. **Build Failures**
   - Check requirements.txt format
   - Verify Python version compatibility
   - Review build logs

2. **Database Connection Issues**
   - Verify DATABASE_URL format
   - Check PostgreSQL service status
   - Test connection from logs

3. **Static File Issues**
   - Ensure correct file paths
   - Check file permissions
   - Verify static file configuration

4. **MPesa Integration Issues**
   - Verify callback URLs are accessible
   - Check environment variables
   - Monitor callback logs

### Getting Help

1. **Render Support**
   - Documentation: docs.render.com
   - Community forum
   - Support tickets (paid plans)

2. **Application Issues**
   - Check application logs
   - Review error messages
   - Test locally first

## Cost Optimization

### Free Tier Usage
- Use for development/testing
- Limited resources and sleep mode
- Good for proof of concept

### Paid Plans
- Better performance and uptime
- No sleep mode
- Priority support

### Cost Management
- Monitor usage regularly
- Right-size your instances
- Use staging environment wisely

## Backup and Recovery

### Database Backups
```bash
# Manual backup
pg_dump $DATABASE_URL > backup.sql

# Restore backup
psql $DATABASE_URL < backup.sql
```

### Application Backups
1. Code: Git repository
2. Configuration: Environment variables export
3. Uploads: Download from Render Disk

## Next Steps

After successful deployment:
1. Set up monitoring and alerts
2. Configure custom domain
3. Test all functionality thoroughly
4. Train users on the system
5. Plan for scaling and maintenance
6. Document operational procedures